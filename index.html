
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¯çµå·¥åŠ Â· IGCSE 0478 ç¬¬3ç« ç¡¬ä»¶ï¼ˆMVP v2ï¼‰</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121b2c; --card2:#17233a; --ink:#e6f0ff; --muted:#9fb2d7;
      --acc:#6ee7ff; --good:#54f2a3; --bad:#ff6b6b; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 600px at 20% -10%, #11203f, #0b1220 40%), var(--bg);
      color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
    }
    .wrap{max-width:980px; margin:0 auto; padding:16px}
    header{display:flex; align-items:center; gap:12px; padding:8px 0 12px}
    .logo{width:42px; height:42px; border-radius:12px; background:linear-gradient(135deg,#48b0ff, #7ef7d4); box-shadow:0 8px 32px rgba(110,231,255,.25)}
    h1{font-size:20px; margin:0}
    .subtitle{font-size:12px; color:var(--muted)}

    .hud{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin:10px 0 16px}
    .stat{background:var(--card); border:1px solid #1f2c48; padding:10px 12px; border-radius:14px; display:flex; align-items:center; justify-content:space-between}
    .stat b{font-size:18px}
    .btn{appearance:none; border:none; background:linear-gradient(180deg,#1f355a,#182742); color:#e8f2ff; padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.25); transition:.15s transform,.15s box-shadow}
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .btn.ghost{background:transparent; border:1px solid #2a3b61}
    .btn.good{background:linear-gradient(180deg,#1b5a3c,#143f2a)}
    .btn.bad{background:linear-gradient(180deg,#5a2626,#452020)}

    .card{background:linear-gradient(180deg,var(--card2),var(--card)); border:1px solid #1f2c48; border-radius:18px; padding:18px; box-shadow:0 16px 40px rgba(0,0,0,.25)}
    .flex{display:flex; gap:12px; flex-wrap:wrap}
    .row{display:flex; align-items:center; gap:12px}

    .mode-tabs{display:flex; gap:6px; flex-wrap:wrap}
    .tab{padding:8px 10px; border-radius:10px; border:1px solid #284065; font-size:12px; cursor:pointer; opacity:.85}
    .tab.active{background:#1a2b48}

    .q-title{font-size:18px; margin:8px 0 6px}
    .prompt{font-size:16px; color:#dbe7ff}

    .options{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
    .opt{border:1px solid #29436b; border-radius:12px; padding:10px; cursor:pointer; background:#14213b}
    .opt:hover{border-color:#3e66a8}
    .opt.correct{border-color:var(--good); box-shadow:0 0 0 2px rgba(84,242,163,.25) inset}
    .opt.wrong{border-color:var(--bad); box-shadow:0 0 0 2px rgba(255,107,107,.2) inset}

    .explain{margin-top:12px; background:#0f1a31; border:1px dashed #2a4066; border-radius:12px; padding:10px; color:#cfe2ff}
    .explain small{color:var(--muted)}

    .footer-ctrl{display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:14px}
    .pill{font-size:12px; color:#bcd3ff; border:1px solid #304d7a; border-radius:24px; padding:6px 10px}

    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}

    .toast{position:fixed; right:16px; bottom:16px; background:#0f1a31; border:1px solid #2a4066; color:#e6f0ff; padding:10px 12px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.3); opacity:0; transform:translateY(10px); transition:.25s}
    .toast.show{opacity:1; transform:translateY(0)}

    .badge{display:inline-block; padding:3px 8px; border:1px solid #2a4066; border-radius:999px; font-size:11px; color:#bcd3ff; margin-left:6px}
    .progress{height:8px; background:#0e1730; border-radius:6px; overflow:hidden; border:1px solid #21365b}
    .bar{height:100%; background:linear-gradient(90deg,#48b0ff,#6ee7ff); width:0%}

    .small{font-size:12px; color:var(--muted)}
    .hidden{display:none}
    .center{display:flex; justify-content:center; align-items:center}
    .mt8{margin-top:8px}
    .mt12{margin-top:12px}
    .mt16{margin-top:16px}
    .mt20{margin-top:20px}
    /* === Mobile-friendly & Hall of Fame styles === */
    .opt{min-height:48px; font-size:15px}
    .hoflist{display:flex; flex-direction:column; gap:10px}
    .hof-item{display:flex; align-items:center; gap:10px; background:#0f1a31; border:1px solid #2a4066; border-radius:14px; padding:10px}
    .hof-img{width:64px; height:64px; object-fit:cover; border-radius:12px; border:1px solid #2a4066}
    .hof-rank{width:28px; height:28px; border-radius:50%; border:1px solid #2a4066; display:flex; align-items:center; justify-content:center; font-weight:700}
    .hof-name{font-weight:600}
    @media (max-width:640px){
      .wrap{padding:12px}
      .options{grid-template-columns:1fr}
      .hud{grid-template-columns:1fr 1fr}
      .grid-2{grid-template-columns:1fr}
      .btn{padding:12px 16px; font-size:16px}
      .opt{min-height:56px; font-size:16px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <div>
        <h1>è¯çµå·¥åŠ LexiForge <span class="badge">0478 Â· ç¬¬3ç«  ç¡¬ä»¶</span></h1>
        <div class="subtitle">ç›®æ ‡ï¼šè®°ä½ä¸­è‹±é‡Šä¹‰ï¼ˆCN/ENï¼‰ï¼ŒæŒæ¡å­¦ç§‘æ¦‚å¿µä¸ç”¨æ³•ï¼ˆDISCï¼‰ã€‚ç¦»çº¿å¯ç”¨ Â· æœ¬åœ°ä¿å­˜è¿›åº¦ã€‚</div>
      </div>
    </header>

    <div class="hud">
      <div class="stat"><span>åˆ†æ•°</span><b id="score">0</b></div>
      <div class="stat"><span>è¿å‡»</span><b id="streak">0</b></div>
      <div class="stat"><span>å‰©ä½™æ—¶é—´</span><b id="timer">90s</b></div>
      <div class="stat"><span>è¿›åº¦</span>
        <div style="flex:1; margin-left:10px">
          <div class="progress"><div id="progbar" class="bar"></div></div>
          <div class="small" id="progtext">0 / 15 æœ¬å±€é¢˜ç›®</div>
        </div>
      </div>
    </div>

    <div class="card" id="menu">
      <div class="grid-2">
        <div>
          <h2 style="margin:0 0 6px">å¼€å§‹ä¸€æ¬¡ 90 ç§’æŒ‘æˆ˜</h2>
          <p class="small">åŒ…å«ï¼š<b>å¿«é€ŸåŒ¹é…ï¼ˆCN/ENï¼‰</b> Ã—5ã€<b>æ¦‚å¿µé—¯å…³ï¼ˆDISCï¼‰</b> Ã—5ã€<b>Boss æ•´åˆ</b> Ã—1ï¼›
            é”™é¢˜è‡ªåŠ¨è¿›å…¥â€œæ¸©æ•…æ± â€ï¼Œç¨åä¼˜å…ˆå¤ä¹ ï¼ˆæ¼”ç¤ºç‰ˆä»¥åˆ†é’Ÿè®¡æ—¶ï¼‰ã€‚</p>
          <div class="row mt12">
            <button class="btn" id="startBtn">â–¶ å¼€å§‹æŒ‘æˆ˜</button>
            <button class="btn ghost" id="reviewBtn">â™» ä»…å¤ä¹ åˆ°æœŸè¯</button>
          </div>
          <div class="row mt8">
            <button class="btn ghost" id="resetBtn">ğŸ—‘ é‡ç½®æœ¬åœ°è¿›åº¦</button>
            <button class="btn ghost" id="exportBtn">â¬‡ å¯¼å‡ºè¿›åº¦JSON</button>
            <input class="btn ghost" type="file" id="importFile" accept="application/json" title="å¯¼å…¥è¿›åº¦JSON" />
          </div>
          <p class="small mt8">æç¤ºï¼šæœ¬é¡µä»…éœ€æµè§ˆå™¨å³å¯è¿è¡Œï¼Œæ— éœ€è”ç½‘ã€‚è¿›åº¦ä¿å­˜åœ¨æµè§ˆå™¨ <code>localStorage</code>ã€‚</p>
        </div>
        <div>
          <h3 style="margin:0 0 6px">é€‰æ‹©é¢˜é‡ï¼ˆæ¼”ç¤ºï¼‰</h3>
          <div class="mode-tabs" id="qtyTabs"></div>
          <p class="small">å»ºè®® 11~15 é¢˜ä¸€å±€ã€‚è¯åº“ï¼šIGCSE 0478 Chapter 3ï¼ˆç¡¬ä»¶ï¼‰æ ¸å¿ƒè¯ 12 ä¸ªã€‚</p>
        </div>
      </div>
    </div>

    <div id="game" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="pill" id="phasePill">â€”</div>
          <div class="small mt8" id="dueInfo">æ¸©æ•…æ± ï¼šâ€”</div>
        </div>
        <div class="row" style="gap:6px">
          <button class="btn ghost" id="pauseBtn">â¸ æš‚åœ</button>
          <button class="btn ghost" id="quitBtn">â¹ ç»“æŸ</button>
        </div>
      </div>

      <div class="q-title" id="qTitle">â€”</div>
      <div class="prompt" id="prompt">â€”</div>
      <div class="options" id="options"></div>
      <div class="explain hidden" id="explain"></div>

      <div class="footer-ctrl">
        <div class="small">ç­”é¢˜åä¼šæ˜¾ç¤ºè§£æï¼›æŒ‰ <b>Enter</b> å¯ç»§ç»­ã€‚</div>
        <button class="btn" id="nextBtn" disabled>ä¸‹ä¸€é¢˜ â–¶</button>
      </div>
    </div>

    <div id="result" class="card hidden">
      <h2 style="margin:0 0 8px">æœ¬å±€ç»“æœ</h2>
      <div class="grid-2">
        <div>
          <p>å¾—åˆ†ï¼š<b id="finalScore">0</b>ï½œæœ€é«˜è¿å‡»ï¼š<b id="finalStreak">0</b></p>
          <p id="summaryText" class="small"></p>
          <button class="btn" id="againBtn">å†æ¥ä¸€å±€</button>
        </div>
        <div>
          <h3 style="margin:0 0 6px">è¿‘æœŸå°†å¤ä¹ ï¼ˆæ¼”ç¤ºï¼šä»¥åˆ†é’Ÿä¸ºå•ä½ï¼‰</h3>
          <ul id="upcoming" class="small" style="padding-left:18px; margin:0"></ul>
        </div>
      </div>
    </div>

    <div id="toast" class="toast">å·²ä¿å­˜</div>
  </div>

  <script>
    // === è¯åº“ï¼ˆIGCSE 0478 Chapter 3ï¼šHardwareï¼‰ ===
    const WORDS = [
      { id:"alu", word:"ALU", cn:"ç®—æœ¯é€»è¾‘å•å…ƒ", en:"Performs arithmetic and logical operations", disc:"CPU component executing ADD/AND/OR/SHIFT etc.", scenario:"åœ¨æ‰§è¡Œ ADDã€AND è¿™ç±»è¿ç®—æ—¶ï¼Œå¤„ç†å™¨æŠŠæ“ä½œæ•°é€åˆ°åŒä¸€å•å…ƒè¿›è¡Œè®¡ç®—ã€‚", coll:["ALU operation","status flags"], miscon:["CU","Register","Cache"] },
      { id:"cu", word:"Control Unit (CU)", cn:"æ§åˆ¶å™¨", en:"Directs processor operations; fetches and decodes instructions", disc:"Controls the movement of data and instructions within the CPU.", scenario:"å–æŒ‡-è¯‘ç -æ‰§è¡Œå¾ªç¯ä¸­ï¼Œè´Ÿè´£å‘å‡ºè¯»/å†™/æ§åˆ¶ä¿¡å·çš„éƒ¨ä»¶ã€‚", coll:["fetch-decode-execute","control signals"], miscon:["ALU","Register","Scheduler"] },
      { id:"reg", word:"Register", cn:"å¯„å­˜å™¨", en:"Very small, very fast storage inside CPU", disc:"Holds immediate values like operands, addresses, instructions.", scenario:"éœ€è¦åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…è¯»å–çš„ä¸´æ—¶æ•°æ®æ”¾åœ¨ä¸€ä¸ªæå°è€Œæå¿«çš„å­˜å‚¨ä½ç½®ã€‚", coll:["PC","MAR","MDR","ACC"], miscon:["Cache","RAM","Buffer"] },
      { id:"cache", word:"Cache", cn:"é«˜é€Ÿç¼“å­˜", en:"Small, fast memory that stores frequently used data to reduce latency", disc:"Located between CPU and RAM; improves average access time.", scenario:"ä¸ºç»å¸¸è®¿é—®çš„æ•°æ®æä¾›æ›´å¿«å‘½ä¸­è·¯å¾„ï¼Œä»è€Œé™ä½å¹³å‡è®¿é—®å»¶è¿Ÿã€‚", coll:["L1 L2 L3","cache hit"], miscon:["Buffer","Register","RAM"] },
      { id:"buffer", word:"Buffer", cn:"ç¼“å†²åŒº/ç¼“å†²", en:"Temporary storage to smooth rate differences between devices", disc:"Used in I/O or networking to handle bursty data and rate mismatch.", scenario:"ç£ç›˜å†™å…¥é€Ÿåº¦ä½äºè¾“å…¥æµï¼Œä¸´æ—¶å­˜æ”¾æ•°æ®ä»¥å¹³æ»‘é€Ÿç‡ã€‚", coll:["buffer overflow","double buffering"], miscon:["Cache","Register","RAM"] },
      { id:"addrbus", word:"Address Bus", cn:"åœ°å€æ€»çº¿", en:"Carries memory addresses (usually from CPU to memory)", disc:"Typically unidirectional; width defines maximum addressable space.", scenario:"CPU æŠŠè¦è®¿é—®çš„ä½ç½®ç¼–å·é€å¾€å†…å­˜æˆ–è®¾å¤‡ï¼Œçº¿åªä¼ åœ°å€ä¸ä¼ æ•°æ®ã€‚", coll:["address width","memory map"], miscon:["Data Bus","Control Bus","USB"] },
      { id:"databus", word:"Data Bus", cn:"æ•°æ®æ€»çº¿", en:"Carries data between CPU, memory and I/O (bidirectional)", disc:"Width affects how much data transferred per cycle.", scenario:"å¤„ç†å™¨ä¸å†…å­˜ä¹‹é—´æ¥å›æ¬è¿å­—ï¼ˆwordï¼‰ï¼Œçº¿æ—¢å¯è¯»ä¹Ÿå¯å†™ã€‚", coll:["bus width","bandwidth"], miscon:["Address Bus","Control Bus","Network bus"] },
      { id:"ctrlbus", word:"Control Bus", cn:"æ§åˆ¶æ€»çº¿", en:"Carries control signals (e.g., read/write, interrupt, clock)", disc:"Coordinates timing and direction of operations.", scenario:"å‘å‡ºè¯»/å†™ã€ç¡®è®¤ã€æ—¶é’Ÿç­‰ä¿¡å·æ¥æŒ‡æŒ¥æ•°æ®ä¸åœ°å€çº¿çš„é…åˆã€‚", coll:["read/write","interrupt","clock"], miscon:["Data Bus","Address Bus","Power line"] },
      { id:"ram", word:"RAM", cn:"éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆä¸»å­˜ï¼‰", en:"Volatile main memory for programs and data in use", disc:"Loses content when power is off; working area for running programs.", scenario:"è®¡ç®—ä¸­ä¸´æ—¶æ”¾ç½®å½“å‰è¿è¡Œç¨‹åºä¸æ•°æ®çš„åœ°æ–¹ï¼Œæ–­ç”µåæ¶ˆå¤±ã€‚", coll:["DRAM","SRAM"], miscon:["ROM","Cache","Secondary Storage"] },
      { id:"rom", word:"ROM", cn:"åªè¯»å­˜å‚¨å™¨", en:"Non-volatile memory storing firmware/boot code", disc:"Contents persist without power; typically read-only during normal use.", scenario:"è®¾å¤‡ä¸Šç”µåæœ€å…ˆæ‰§è¡Œçš„å¼•å¯¼ç¨‹åºæ”¾åœ¨ä¸ä¼šä¸¢å¤±çš„èŠ¯ç‰‡é‡Œã€‚", coll:["firmware","bootloader"], miscon:["RAM","SSD","EEPROM"] },
      { id:"sec", word:"Secondary Storage", cn:"äºŒçº§å­˜å‚¨ï¼ˆå¤–å­˜ï¼‰", en:"Non-volatile long-term storage like SSD/HDD", disc:"Persists data across power cycles; slower than RAM but larger capacity.", scenario:"æ–‡æ¡£å’Œè§†é¢‘é•¿æœŸä¿å­˜çš„ä½ç½®ï¼Œæ‰ç”µä»èƒ½ä¿ç•™ã€‚", coll:["SSD","HDD","optical"], miscon:["RAM","Cache","Register"] },
      { id:"intr", word:"Interrupt", cn:"ä¸­æ–­", en:"Signal that pauses CPU to service an event", disc:"Causes CPU to save context and jump to an ISR.", scenario:"é”®ç›˜æ•²å‡»ä½¿å¤„ç†å™¨æš‚æ—¶æ‰“æ–­å½“å‰ä»»åŠ¡ï¼Œè½¬å»æ‰§è¡ŒæœåŠ¡ç¨‹åºã€‚", coll:["ISR","priority","mask"], miscon:["Polling","DMA","Clock"] },
    ];

    // === æœ¬åœ°å­˜å‚¨ï¼ˆç®€ç‰ˆ SRSï¼Œåˆ†é’Ÿé—´éš”ï¼Œæ¼”ç¤ºç”¨ï¼‰ ===
    const LS_KEY = 'lexiforge0478_hw_srs_v1';
    const FACE_KEYS = ['CN','EN','DISC'];
    const INTERVALS_MIN = [1, 3, 10, 60, 180];

    function loadProgress(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {}; }catch{ return {}; } }
    function saveProgress(p){ localStorage.setItem(LS_KEY, JSON.stringify(p)); }
    let progress = loadProgress();

    function ensureCardProgress(id){ if(!progress[id]) progress[id] = { CN:{lvl:0,due:0}, EN:{lvl:0,due:0}, DISC:{lvl:0,due:0} }; return progress[id]; }
    function schedule(faceObj, correct){
      if(correct){ faceObj.lvl = Math.min( faceObj.lvl + 1, INTERVALS_MIN.length ); } else { faceObj.lvl = Math.max( faceObj.lvl - 1, 0 ); }
      const idx = Math.max(0, Math.min(faceObj.lvl, INTERVALS_MIN.length-1)); const mins = INTERVALS_MIN[idx];
      faceObj.due = Date.now() + mins*60*1000;
    }
    function dueFacesNow(){ const now = Date.now(); let due = []; for(const w of WORDS){ const cp = ensureCardProgress(w.id); for(const f of FACE_KEYS){ if(cp[f].due && cp[f].due <= now) due.push({id:w.id, face:f}); } } return due; }

    const $ = s=>document.querySelector(s);
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function sample(arr, n){ return shuffle(arr.slice()).slice(0,n); }
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1500); }

    async function compressImage(file, maxW=512, maxH=512, mime='image/jpeg', quality=.85){
      return new Promise((resolve,reject)=>{
        try{
          const isGif = (file.type && file.type.toLowerCase().includes('gif')) || /\.gif$/i.test(file.name||'') || !file.type;
          const fr=new FileReader();
          fr.onload=()=>{
            const img=new Image();
            img.onload=()=>{
              let w=img.width, h=img.height; const r=Math.min(maxW/w, maxH/h, 1); w=Math.round(w*r); h=Math.round(h*r);
              const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d');
              try{ ctx.drawImage(img,0,0,w,h); }catch(e){ return reject(e); }
              let q=isGif? Math.min(0.7, quality): quality; let dataUrl;
              try{ dataUrl=c.toDataURL(mime, q); }catch{ dataUrl=c.toDataURL(); }
              resolve({dataUrl, note: isGif ? 'åŠ¨å›¾è¾ƒå¤§ä¼šè½¬ä¸ºé™æ€å°é¢ä»¥èŠ‚çœç©ºé—´' : ''});
            };
            img.onerror=()=>reject(new Error('IMAGE_DECODE_ERROR')); img.src=fr.result;
          };
          fr.onerror=reject; fr.readAsDataURL(file);
        }catch(e){ reject(e); }
      });
    }

    function genCNQ(card){ const opts = new Set([card.cn]); while(opts.size<4){ opts.add(sample(WORDS.filter(w=>w.id!==card.id),1)[0].cn); } const options = shuffle([...opts]).map(text=>({text, correct: text===card.cn})); return { phase:'å¿«é€ŸåŒ¹é… Â· CN', prompt:`ã€è‹±æ–‡â†’ä¸­æ–‡ã€‘é€‰æ‹© <b>${card.word}</b> çš„ä¸­æ–‡é‡Šä¹‰`, explain:`<b>${card.word}</b>ï¼š${card.cn}ï½œ<small>${card.en}</small>`, options, face:'CN' }; }
    function genENQ(card){ const defs = new Set([card.en]); while(defs.size<4){ defs.add(sample(WORDS.filter(w=>w.id!==card.id),1)[0].en); } const options = shuffle([...defs]).map(text=>({text, correct: text===card.en})); return { phase:'å¿«é€ŸåŒ¹é… Â· EN', prompt:`ã€ä¸­æ–‡â†’è‹±æ–‡ã€‘é€‰æ‹© <b>${card.cn}</b> çš„è‹±æ–‡é‡Šä¹‰`, explain:`<b>${card.word}</b>ï¼š${card.en}ï½œ<small>${card.disc}</small>`, options, face:'EN' }; }
    function genDISCQ(card){ let pool = WORDS.filter(w=>w.id!==card.id); let distract = []; for(const m of card.miscon){ const hit = WORDS.find(w=>w.word.split(' (')[0]===m || w.id===m.toLowerCase()); if(hit && hit.id!==card.id) distract.push(hit); } if(distract.length<3){ distract = distract.concat( sample(pool.filter(w=>!distract.includes(w)), 3-distract.length) ); } const candidates = shuffle( [card, ...sample(distract,3)] ); const options = candidates.map(w=>({text:`${w.word}ï¼ˆ${w.cn}ï¼‰`, correct:w.id===card.id})); return { phase:'æ¦‚å¿µé—¯å…³ Â· DISC', prompt:`ã€åœºæ™¯åˆ¤æ–­ã€‘${card.scenario} â€”â€” ä»¥ä¸Šæœ€å¥‘åˆçš„æ˜¯ï¼Ÿ`, explain:`<b>${card.word}</b>ï¼š${card.disc}ï½œ<small>${card.en}</small>`, options, face:'DISC' }; }
    function genBOSSQ(card){ const defs = new Set([card.en]); while(defs.size<4){ defs.add(sample(WORDS.filter(w=>w.id!==card.id),1)[0].en); } const defOptions = shuffle([...defs]).map(text=>({text, correct: text===card.en})); return { phase:'BOSS Â· æ•´åˆ', prompt:`ã€æ•´åˆã€‘è¯»åœºæ™¯å¹¶é€‰æ‹©æœ€è´´åˆ‡çš„æœ¯è¯­ï¼Œç„¶åé€‰æ‹©å…¶è‹±æ–‡å®šä¹‰ã€‚<br><br><i>${card.scenario}</i>`, explain:`<b>${card.word}</b>ï¼š${card.cn}ï½œ${card.en}ï½œ<small>${card.disc}</small>`, options:[ { text:`${card.word}ï¼ˆ${card.cn}ï¼‰`, correct:true, bossSub:defOptions }, ...sample(WORDS.filter(w=>w.id!==card.id),3).map(w=>({ text:`${w.word}ï¼ˆ${w.cn}ï¼‰`, correct:false })) ], boss:true, face:'DISC' }; }

    let game = null;
    function buildQueue(total=15, reviewOnly=false){ const due = dueFacesNow(); const dueInfoTxt = due.length ? `åˆ°æœŸ ${due.length} é¡¹ï¼ˆCN/EN/DISC é¢å‘ï¼‰` : 'æš‚æ— åˆ°æœŸé¡¹'; $('#dueInfo').textContent = `æ¸©æ•…æ± ï¼š${dueInfoTxt}`; const baseCards = reviewOnly && due.length ? [...new Set(due.map(x=>x.id))].map(id=>WORDS.find(w=>w.id===id)) : sample(WORDS, Math.min(5, WORDS.length)); let queue = []; for(const c of baseCards){ queue.push( Math.random()<0.5 ? genCNQ(c) : genENQ(c) ); } for(const c of baseCards){ queue.push( genDISCQ(c) ); } queue.push( genBOSSQ(sample(baseCards,1)[0]) ); while(queue.length < total){ const c = sample(WORDS,1)[0]; const t = Math.random(); queue.push( t<.34 ? genCNQ(c) : t<.67 ? genENQ(c) : genDISCQ(c) ); } return queue.slice(0,total); }
    function startGame({total=15, reviewOnly=false}={}){ $('#menu').classList.add('hidden'); $('#result').classList.add('hidden'); $('#game').classList.remove('hidden'); game = { queue: buildQueue(total, reviewOnly), idx:0, score:0, streak:0, timeLeft:90, running:true }; updateHUD(); renderQ(); tick(); }
    function quitGame(){ game.running=false; $('#game').classList.add('hidden'); $('#menu').classList.remove('hidden'); }
    function updateHUD(){ $('#score').textContent = game.score; $('#streak').textContent = game.streak; $('#timer').textContent = game.timeLeft+ 's'; const total = game.queue.length; const done = game.idx; const pct = Math.floor((done/total)*100); $('#progbar').style.width = pct+'%'; $('#progtext').textContent = `${done} / ${total} æœ¬å±€é¢˜ç›®`; }
    function renderQ(){ const q = game.queue[game.idx]; if(!q){ return endGame(); } $('#phasePill').textContent = q.phase; $('#qTitle').innerHTML = `ç¬¬ ${game.idx+1} é¢˜`; $('#prompt').innerHTML = q.prompt; const optBox = $('#options'); optBox.innerHTML=''; $('#explain').classList.add('hidden'); $('#explain').innerHTML=''; $('#nextBtn').disabled = true; q.options.forEach((o)=>{ const div = document.createElement('div'); div.className='opt'; div.tabIndex=0; div.innerHTML = o.text; div.addEventListener('click', ()=>handlePick(q, div, o)); div.addEventListener('keyup', (e)=>{ if(e.key==='Enter') handlePick(q, div, o); }); optBox.appendChild(div); }); }
    function handlePick(q, el, opt){ if($('#nextBtn').disabled===false) return; const nodes = [...document.querySelectorAll('.opt')]; let correct = !!opt.correct; nodes.forEach(n=>{ const text = n.innerHTML; const isCorrect = q.boss ? (text.includes(q.options.find(x=>x.correct).text)) : q.options.find(x=>x.text===text)?.correct; n.classList.add(isCorrect? 'correct':'wrong'); }); if(q.boss && correct){ const subBox = document.createElement('div'); subBox.className='options mt12'; q.options.find(x=>x.correct).bossSub.forEach(sub=>{ const d = document.createElement('div'); d.className='opt'; d.tabIndex=0; d.innerHTML = sub.text; d.addEventListener('click', ()=>{ const all=[...subBox.children]; all.forEach(n=>n.classList.add(n.innerHTML===sub.text && sub.correct ? 'correct':'wrong')); finalizeAnswer(q, correct && sub.correct); }); d.addEventListener('keyup',(e)=>{ if(e.key==='Enter'){ d.click(); }}); subBox.appendChild(d); }); $('#options').appendChild(subBox); $('#explain').classList.remove('hidden'); $('#explain').innerHTML = q.explain + '<div class="small mt8">å·²é€‰å¯¹æœ¯è¯­ï¼Œè¯·é€‰æ‹©å¯¹åº”è‹±æ–‡å®šä¹‰ã€‚</div>'; return; } finalizeAnswer(q, correct); }
    function finalizeAnswer(q, correct){ $('#explain').classList.remove('hidden'); $('#explain').innerHTML = q.explain + (correct? ` <span style="color:var(--good)">âœ“ æ­£ç¡®</span>` : ` <span style="color:var(--bad)">âœ— å†æƒ³æƒ³ï¼ˆå·²è®°å½•å¤ä¹ ï¼‰</span>`); $('#nextBtn').disabled = false; if(correct){ game.score += 10 + Math.min(game.streak, 10); game.streak += 1; } else { game.streak = 0; } updateHUD(); const card = WORDS.find(w=> q.prompt.includes(w.word) || q.explain.includes(w.word)); if(card){ const cp = ensureCardProgress(card.id); schedule(cp[q.face], correct); saveProgress(progress); } }
    function nextQ(){ game.idx += 1; updateHUD(); if(game.idx >= game.queue.length){ endGame(); } else { renderQ(); } }
    function endGame(){ game.running=false; $('#game').classList.add('hidden'); $('#result').classList.remove('hidden'); $('#finalScore').textContent = game.score; $('#finalStreak').textContent = game.streak; const items=[]; const now=Date.now(); for(const w of WORDS){ const cp = ensureCardProgress(w.id); for(const f of FACE_KEYS){ if(cp[f].due>now) items.push({w, f, inMin: Math.round((cp[f].due-now)/60000)}); }} items.sort((a,b)=>a.inMin-b.inMin); const ul=$('#upcoming'); ul.innerHTML=''; items.slice(0,10).forEach(it=>{ const li=document.createElement('li'); li.textContent=`${it.w.word} Â· ${it.f} é¢å‘ï¼š${it.inMin} åˆ†é’Ÿå`; ul.appendChild(li); }); const mastered = WORDS.filter(w=>{ const cp=ensureCardProgress(w.id); return FACE_KEYS.every(f=>cp[f].lvl>=4); }).length; $('#summaryText').textContent = `å·²ç²¾é€šè¯ï¼ˆæ‰€æœ‰é¢å‘â‰¥4ï¼‰ï¼š${mastered} / ${WORDS.length}`; }

    let timerId=null; function tick(){ clearInterval(timerId); timerId = setInterval(()=>{ if(!game?.running) return clearInterval(timerId); if(game.timeLeft<=0){ clearInterval(timerId); return endGame(); } game.timeLeft -= 1; $('#timer').textContent = game.timeLeft+'s'; },1000); }

    $('#startBtn').addEventListener('click', ()=> startGame({ total: currentQty, reviewOnly:false }));
    $('#reviewBtn').addEventListener('click', ()=> startGame({ total: currentQty, reviewOnly:true }));
    $('#resetBtn').addEventListener('click', ()=>{ if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æœ¬åœ°è¿›åº¦ï¼Ÿ')){ localStorage.removeItem(LS_KEY); progress={}; toast('å·²é‡ç½®'); }});
    $('#exportBtn').addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(progress,null,2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'lexiforge_progress.json'; a.click(); });
    $('#importFile').addEventListener('change', (e)=>{ const file = e.target.files?.[0]; if(!file) return; const fr = new FileReader(); fr.onload = ()=>{ try{ progress = JSON.parse(fr.result); saveProgress(progress); toast('å·²å¯¼å…¥è¿›åº¦'); }catch{ alert('å¯¼å…¥å¤±è´¥ï¼šJSON æ ¼å¼é”™è¯¯'); } }; fr.readAsText(file); });
    $('#pauseBtn').addEventListener('click', ()=>{ game.running=!game.running; $('#pauseBtn').textContent = game.running? 'â¸ æš‚åœ':'â–¶ ç»§ç»­'; if(game.running) tick(); });
    $('#quitBtn').addEventListener('click', quitGame);
    $('#againBtn').addEventListener('click', ()=>{ $('#menu').classList.remove('hidden'); $('#result').classList.add('hidden'); });
    $('#nextBtn').addEventListener('click', nextQ);
    window.addEventListener('keyup', (e)=>{ if(e.key==='Enter' && !$('#nextBtn').disabled) nextQ(); });

    const qtyOptions=[11,13,15,17]; let currentQty=15; const qtyTabs=$('#qtyTabs');
    function renderQtyTabs(){ qtyTabs.innerHTML=''; qtyOptions.forEach(q=>{ const b=document.createElement('button'); b.className='tab'+(q===currentQty?' active':''); b.textContent=q+' é¢˜/å±€'; b.addEventListener('click', ()=>{ currentQty=q; renderQtyTabs(); }); qtyTabs.appendChild(b); }); } renderQtyTabs();

    const LS_PLAYERS = 'lexiforge0478_hw_players_v1'; const LS_HOF = 'lexiforge0478_hw_hof_v1';
    function loadArr(k){ try{ return JSON.parse(localStorage.getItem(k)) || []; }catch{ return []; } }
    function saveArr(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
    function rankPlayers(arr){ return arr.slice().sort((a,b)=> b.score - a.score || a.tms - b.tms); }
    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function addToPlayers(name, score){ const arr=loadArr(LS_PLAYERS); const rec={name, score, tms:Date.now()}; arr.push(rec); saveArr(LS_PLAYERS, arr); return rec; }
    function hofQualified(score){ const hof = rankPlayers(loadArr(LS_HOF)); if(hof.length<10) return true; const last = hof[hof.length-1]; return score>last.score || (score===last.score && Date.now()<last.tms); }
    function submitToHoF(name, score, skill, img){ const hof = loadArr(LS_HOF); hof.push({name, score, skill, img, tms:Date.now()}); const ranked = rankPlayers(hof).slice(0,10); try{ saveArr(LS_HOF, ranked); }catch(e){ throw e; } return ranked; }

    function ensureHoFUI(){ if(document.querySelector('#hof')) return; const hofCard=document.createElement('div'); hofCard.id='hof'; hofCard.className='card hidden'; hofCard.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">ğŸ† åäººå ‚ Hall of Fame</h2>
        <button class="btn ghost" id="hofBackBtn">â† è¿”å›</button>
      </div>
      <div class="small" style="margin:6px 0 12px">å±•ç¤ºå†å²å‰10åï¼šåˆ†æ•°ï½œåå­—ï½œæŠ€èƒ½åï½œå›¾ç‰‡</div>
      <div id="hofList" class="hoflist"></div>`; document.querySelector('.wrap').appendChild(hofCard);
      hofCard.querySelector('#hofBackBtn').addEventListener('click', ()=>{ document.querySelector('#hof').classList.add('hidden'); document.querySelector('#menu').classList.remove('hidden'); }); }
    function renderHoF(){ const list=document.querySelector('#hofList'); if(!list) return; const hof=rankPlayers(loadArr(LS_HOF)).slice(0,10); list.innerHTML=''; hof.forEach((r,i)=>{ const div=document.createElement('div'); div.className='hof-item'; div.innerHTML = `
      <div class="hof-rank">${i+1}</div>
      <img class="hof-img" src="${r.img||''}" alt="img"/>
      <div class="hof-meta">
        <div class="hof-name">${escapeHtml(r.name)}</div>
        <div class="small">åˆ†æ•°ï¼š${r.score}ï½œæŠ€èƒ½ï¼š${escapeHtml(r.skill||'â€”')}</div>
      </div>`; list.appendChild(div); }); }
    function openHoF(){ ensureHoFUI(); ['#menu','#game','#result'].forEach(sel=>{ const el=document.querySelector(sel); if(el) el.classList.add('hidden');}); document.querySelector('#hof').classList.remove('hidden'); renderHoF(); }

    function buildResultExtras(){ if(document.querySelector('#nameRow')) return; const res=document.querySelector('#result'); const extra=document.createElement('div'); extra.id='resultExtras'; extra.innerHTML = `
      <hr style="border:none;border-top:1px dashed #2a4066;margin:12px 0">
      <div id="nameRow">
        <label class="small">è¯·è¾“å…¥åå­—ï¼ˆå¿…å¡«ï¼Œå¯ç”¨ä»»ä½•æ–‡å­—ä¸è¡¨æƒ…ï¼‰ï¼š</label>
        <div class="row mt8">
          <input id="nameInput" class="text" placeholder="ä½ çš„åå­— âœ¨" maxlength="40" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid #2a4066; background:#0f1a31; color:#e6f0ff" />
          <button class="btn" id="saveNameBtn">ä¿å­˜æˆç»©</button>
        </div>
      </div>
      <div id="afterSave" class="hidden mt12">
        <div>æœ¬å±€ç©å®¶ï¼š<b id="afterSaveName"></b>ï½œåˆ†æ•°ï¼š<b id="afterSaveScore"></b></div>
      </div>
      <div id="hofTop" class="mt16">
        <div class="small">å½“å‰åäººå ‚ç¬¬ä¸€åï¼š</div>
        <div id="hofTop1" class="mt8 small"></div>
      </div>
      <div id="hofUpload" class="hidden mt16">
        <h3 style="margin:0 0 6px">ğŸ‰ æ­å–œè¿›å…¥å‰10ï¼å®Œå–„ä¸ªäººå±•ç¤ºï¼š</h3>
        <div class="small">ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼ˆjpg/png/webp/gifï¼›åŠ¨å›¾ä¼šè½¬ä¸ºé™æ€å°é¢ä»¥èŠ‚çœç©ºé—´ï¼‰å¹¶å¡«å†™ä¸€ä¸ªæŠ€èƒ½åï¼š</div>
        <div class="row mt8" style="flex-wrap:wrap; gap:10px">
          <input type="file" id="hofImgInput" accept="image/*,.gif" class="btn ghost" />
          <img id="hofPreview" alt="é¢„è§ˆ" style="width:64px;height:64px;border-radius:12px;object-fit:cover;border:1px solid #2a4066;display:none" />
        </div>
        <div class="row mt8">
          <input id="skillInput" class="text" placeholder="æŠ€èƒ½åï¼ˆä¾‹å¦‚ï¼šCache Masterï¼‰" maxlength="32" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid #2a4066; background:#0f1a31; color:#e6f0ff" />
          <button class="btn good" id="hofSubmitBtn">æäº¤åˆ°åäººå ‚</button>
        </div>
      </div>
      <div class="row mt16">
        <button class="btn ghost" id="hofBtn2">ğŸ† æŸ¥çœ‹åäººå ‚</button>
      </div>`; res.appendChild(extra);

      document.querySelector('#hofBtn2').addEventListener('click', openHoF);
      document.querySelector('#hofImgInput').addEventListener('change', async (e)=>{
        const f=e.target.files?.[0]; if(!f) return;
        const isGif = (f.type && f.type.toLowerCase().includes('gif')) || /\.gif$/i.test(f.name||'') || !f.type;
        try{ const {dataUrl, note} = await compressImage(f, isGif?384:512, isGif?384:512, 'image/jpeg', isGif?0.7:0.85); const img=document.querySelector('#hofPreview'); img.src=dataUrl; img.style.display='block'; img.dataset.src=dataUrl; if(note) toast(note); }catch{ alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·æ¢ä¸€å¼ æˆ–æˆªå›¾åå†è¯•'); }
      });
      document.querySelector('#hofSubmitBtn').addEventListener('click', async ()=>{
        const btn = document.querySelector('#hofSubmitBtn');
        const rec = game?.currentPlayer; if(!rec){ return alert('è¯·å…ˆä¿å­˜åå­—'); }
        const skill = document.querySelector('#skillInput').value.trim(); if(!skill){ return alert('è¯·è¾“å…¥æŠ€èƒ½å'); }
        const img = document.querySelector('#hofPreview').dataset.src || '';
        btn.disabled = true;
        try{ submitToHoF(rec.name, rec.score, skill, img); toast('å·²åŠ å…¥åäººå ‚'); document.querySelector('#hofUpload').classList.add('hidden'); renderHoF(); refreshTop1InResult(); }catch(e){ alert('æäº¤å¤±è´¥ï¼šå›¾ç‰‡è¿‡å¤§æˆ–æµè§ˆå™¨å­˜å‚¨å·²æ»¡ã€‚è¯·æ¢æ›´å°çš„å›¾ç‰‡/æˆªå›¾åé‡è¯•'); } finally { btn.disabled = false; }
      });
      document.querySelector('#saveNameBtn').addEventListener('click', ()=>{
        const name = document.querySelector('#nameInput').value.trim(); if(!name){ alert('è¯·è¾“å…¥åå­—'); return; }
        const rec = addToPlayers(name, game.score); game.currentPlayer = rec;
        document.querySelector('#afterSaveName').textContent = rec.name;
        document.querySelector('#afterSaveScore').textContent = rec.score;
        document.querySelector('#afterSave').classList.remove('hidden');
        document.querySelector('#nameRow').classList.add('hidden');
        document.querySelector('#againBtn').disabled = false;
        if(hofQualified(rec.score)){ document.querySelector('#hofUpload').classList.remove('hidden'); } else { document.querySelector('#hofUpload').classList.add('hidden'); }
        refreshTop1InResult();
      });
    }
    function refreshTop1InResult(){ const hof=rankPlayers(loadArr(LS_HOF)); const top=hof[0]; const box=document.querySelector('#hofTop1'); if(!box) return; if(top){ box.innerHTML = `<div class="row" style="gap:10px"><img src="${top.img||''}" alt="top" style="width:48px;height:48px;border-radius:10px;object-fit:cover;border:1px solid #2a4066"/><div><div><b>${escapeHtml(top.name)}</b></div><div class="small">åˆ†æ•°ï¼š${top.score}ï½œæŠ€èƒ½ï¼š${escapeHtml(top.skill||'â€”')}</div></div></div>`; } else { box.innerHTML = '<div class="small">æš‚æ— è®°å½•</div>'; } }

    (function(){ const menu=document.querySelector('#menu'); if(!menu) return; const rows=menu.querySelectorAll('.row'); const last=rows[rows.length-1]; if(!last) return; const b=document.createElement('button'); b.className='btn ghost'; b.id='hofBtn1'; b.textContent='ğŸ† åäººå ‚'; b.addEventListener('click', openHoF); last.appendChild(b); })();

    const _endGame=endGame; endGame=function(){ _endGame(); buildResultExtras(); const again=document.querySelector('#againBtn'); if(again){ again.disabled = true; } const nr=document.querySelector('#nameRow'); if(nr) nr.classList.remove('hidden'); const asv=document.querySelector('#afterSave'); if(asv) asv.classList.add('hidden'); const hup=document.querySelector('#hofUpload'); if(hup) hup.classList.add('hidden'); refreshTop1InResult(); };
  </script>
</body>
</html>
